import {
  configure,
  DataCaptureContext,
  DataCaptureView,
  Camera,
  FrameSourceState
} from "@scandit/web-datacapture-core";
import {
  barcodeCaptureLoader,
  BarcodeCapture,
  BarcodeCaptureSettings,
  BarcodeCaptureOverlay,
  Symbology
} from "@scandit/web-datacapture-barcode";

let _configured = false;
async function ensureConfigured() {
  if (_configured) return;

  const licenseKey = await new Promise((res, rej) =>
    google.script.run.withSuccessHandler(res).withFailureHandler(rej).getScanditLicense()
  );

  await configure({
    licenseKey,
    libraryLocation: "https://cdn.jsdelivr.net/npm/@scandit/web-datacapture-barcode@7.6.0/sdc-lib/",
    moduleLoaders: [barcodeCaptureLoader()]
  });

  _configured = true;
}

function enableEANUPCSymbologies(settings) {
  settings.enableSymbologies([
    Symbology.EAN13UPCA,  // includes UPC-A
    Symbology.UPCE,
    Symbology.EAN8,
    Symbology.Code128
  ]);
  try { settings.codeDuplicateFilter = 0; } catch(_) {}
}

async function scanOnce(containerEl) {
  await ensureConfigured();

  const view = new DataCaptureView();
  view.connectToElement(containerEl);
  view.showProgressBar();

  const context = await DataCaptureContext.create();
  await view.setContext(context);

  const camera = Camera.default;
  const camSettings = BarcodeCapture.recommendedCameraSettings;
  await camera.applySettings(camSettings);
  await context.setFrameSource(camera);

  const settings = new BarcodeCaptureSettings();
  enableEANUPCSymbologies(settings);

  const capture = await BarcodeCapture.forContext(context, settings);
  BarcodeCaptureOverlay.withBarcodeCaptureForView(capture, view);

  async function teardown() {
    try { await capture.setEnabled(false); } catch(_) {}
    try { await camera.switchToDesiredState(FrameSourceState.Off); } catch(_) {}
    try { view.connectToElement(null); } catch(_) {}
  }

  return new Promise(async (resolve) => {
    const listener = {
      didScan: async (_mode, session) => {
        const barcodes = session?.newlyRecognizedBarcodes || [];
        if (!barcodes.length) return;
        const value = barcodes[barcodes.length - 1]?.data ?? '';
        await teardown();
        try { capture.removeListener(listener); } catch(_) {}
        resolve(value || null);
      }
    };
    capture.addListener(listener);

    await camera.switchToDesiredState(FrameSourceState.On);
    await capture.setEnabled(true);
    view.hideProgressBar();
  });
}

// Expose for app.js
window.openScanditScanner = async (containerEl) => {
  try { return await scanOnce(containerEl); }
  catch (e) { console.error('[Scandit] scan error:', e); return null; }
};