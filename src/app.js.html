(function () {
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // DOM & helpers
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const $ = (id) => document.getElementById(id);
  const digits = s => String(s || '').replace(/\D/g, '');
  const toUPC12 = s => { const d = digits(s); return d.length >= 12 ? d.slice(-12) : d.padStart(12, '0'); };
  const spinner = (t) => `<span class="spinner" aria-hidden="true"></span> <span>${t}</span>`;

  const upcInput            = $('upcInput');
  const lookupBtn           = $('lookupBtn');
  const messageDiv          = $('message');
  const resultDiv           = $('result');
  const expirationContainer = $('expirationContainer');
  const expirationInput     = $('expirationInput');
  const createLabelBtn      = $('createLabelBtn');
  const scanUPCBtn          = $('scanUPCBtn');
  const startOverBtn        = $('startOverBtn');

  let currentUPC = null;
  let confirmedData = null;

  function setMsg(text, type) {
    messageDiv.classList.remove('error', 'success');
    if (type === 'error') messageDiv.classList.add('error');
    if (type === 'success') messageDiv.classList.add('success');
    messageDiv.innerHTML = text || '';
  }

  function todayISO() {
    const d = new Date();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${d.getFullYear()}-${m}-${day}`;
  }
  expirationInput.min = todayISO();

  function scrollAfterLayout(el, block = 'center') {
    if (!el) return;
    requestAnimationFrame(() => requestAnimationFrame(() => el.scrollIntoView({ behavior: 'smooth', block })));
  }

  function resetUI() {
    currentUPC = null; confirmedData = null;
    upcInput.value = ''; upcInput.disabled = false; upcInput.focus();
    lookupBtn.disabled = true; lookupBtn.style.display = '';
    scanUPCBtn.disabled = false; scanUPCBtn.style.display = '';
    resultDiv.innerHTML = ''; setMsg('');
    expirationContainer.style.display = 'none';
  }
  startOverBtn.onclick = resetUI;

  // Enable lookup when text present
  upcInput.addEventListener('input', () => {
    upcInput.value = digits(upcInput.value);
    lookupBtn.disabled = upcInput.value.trim() === '';
  });
  // Pad to 12 on blur
  upcInput.addEventListener('blur', () => { if (upcInput.value) upcInput.value = toUPC12(upcInput.value); });
  // Enter triggers lookup
  upcInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !lookupBtn.disabled) {
      e.preventDefault();
      upcInput.value = toUPC12(upcInput.value);
      lookupBtn.click();
    }
  });

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Unified scan flow: Scandit â†’ fallback to Dynamsoft
  // Expects global helpers (added in Index.html):
  //   - openScanditScanner(host)        // returns Promise<string|null>
  //   - openDynamsoftScanner(host)      // returns Promise<string|null>
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function scanWithPreferred(hostEl) {
    // Try Scandit first (if helper exists)
    if (typeof window.openScanditScanner === 'function') {
      try {
        const code = await window.openScanditScanner(hostEl);
        if (code) return code;
      } catch (e) {
        console.warn('[Scan] Scandit failed, falling back â†’ Dynamsoft', e);
      }
    }
    // Fallback to Dynamsoft (if helper exists)
    if (typeof window.openDynamsoftScanner === 'function') {
      const code = await window.openDynamsoftScanner(hostEl);
      if (code) return code;
    }
    // If neither helper exists, throw to surface setup issue
    throw new Error('No scanner helper available. Include scanner-scandit.js or scanner-dynamsoft.js.');
  }

  // Click â†’ open camera, one-shot â†’ close & populate â†’ auto lookup
  scanUPCBtn.addEventListener('click', async () => {
    setMsg('Opening cameraâ€¦');
    resultDiv.innerHTML = `
      <div class="card">
        <div id="scannerHost" class="camera"></div>
      </div>`;
    const host = $('scannerHost');
    scrollAfterLayout(host, 'center');

    let code = null;
    try {
      code = await scanWithPreferred(host);
    } catch (e) {
      console.error(e);
      setMsg('Camera unavailable. Try manual entry.', 'error');
      resultDiv.innerHTML = '';
      return;
    }

    if (!code) {
      setMsg('No barcode detected. Tap Scan to try again.', 'error');
      resultDiv.innerHTML = '';
      return;
    }

    // Success â†’ populate, pad, auto-lookup
    const upc12 = toUPC12(code);
    upcInput.value = upc12;
    lookupBtn.disabled = false;
    setMsg('Scan successful!', 'success');
    resultDiv.innerHTML = '';
    lookupBtn.click();
  });

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Lookup against sheet
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  lookupBtn.addEventListener('click', () => {
    if (!upcInput.value) { setMsg('Please enter a UPC.', 'error'); return; }
    const upc12 = toUPC12(upcInput.value);
    upcInput.value = upc12;

    setMsg(spinner('Looking up UPCâ€¦'));
    lookupBtn.disabled = true; upcInput.disabled = true; resultDiv.innerHTML = '';
    expirationContainer.style.display = 'none'; confirmedData = null;

    google.script.run
      .withSuccessHandler(render)
      .withFailureHandler(err => {
        console.error(err); setMsg('Server error during lookup.', 'error');
        lookupBtn.disabled = false; upcInput.disabled = false;
      })
      .lookupUPC(upc12);
  });

  function render(response) {
    if (response.found) {
      renderFound(response.data);
      lookupBtn.style.display = 'none'; scanUPCBtn.style.display = 'none';
    } else if (response.isNew) {
      lookupBtn.style.display = 'none'; scanUPCBtn.style.display = 'none';
      promptForFrontImage(upcInput.value.trim());
    } else {
      setMsg('UPC does not exist.', 'error');
      lookupBtn.disabled = false; upcInput.disabled = false;
    }
  }

  function renderFound(data) {
    confirmedData = data;
    const cols = ['UPC', 'Species', 'Brand', 'Product Name', 'Flavor', 'Ingredients'];
    let html = '<div class="card"><h3 style="margin:.25rem 0 0 0">Match Found</h3>';
    html += '<table><tr>' + cols.map(h => `<th>${h}</th>`).join('') + '</tr>';
    html += '<tr>' + cols.map(h => `<td>${data[h] || ''}</td>`).join('') + '</tr></table></div>';
    resultDiv.innerHTML = html; setMsg('');
    expirationContainer.style.display = 'block';
    if (expirationInput.value) createLabelBtn.removeAttribute('disabled'); else createLabelBtn.setAttribute('disabled', '');
    expirationContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
    upcInput.disabled = false; lookupBtn.disabled = false;
  }
  expirationInput.addEventListener('change', () => {
    if (expirationInput.value) createLabelBtn.removeAttribute('disabled'); else createLabelBtn.setAttribute('disabled', '');
  });

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // New UPC â†’ capture photos (plain getUserMedia, not barcode)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function promptForFrontImage(upc) {
    currentUPC = upc;
    setMsg('New UPC. Take a clear photo of the FRONT of the package.');
    resultDiv.innerHTML = `
      <div class="card">
        <div class="actions">
          <button id="takeFrontBtn" class="btn">Take Front Photo</button>
        </div>
        <div id="cameraContainer" class="camera"></div>
      </div>`;
    $('takeFrontBtn').onclick = () => openCaptureInto('cameraContainer', 'front');
  }

  function promptForIngredients() {
    setMsg('Now take a clear photo of the INGREDIENTS label.');
    resultDiv.innerHTML = `
      <div class="card">
        <div class="actions">
          <button id="takeIngBtn" class="btn">Take Ingredients Photo</button>
        </div>
        <div id="ingCameraContainer" class="camera"></div>
      </div>`;
    $('takeIngBtn').onclick = () => openCaptureInto('ingCameraContainer', 'ingredients');
  }

  async function openCaptureInto(containerId, kind) {
    const container = $(containerId);
    container.innerHTML = `
      <video id="${kind}Video" autoplay playsinline></video>
      <div class="actions" style="margin-top:.5rem">
        <button id="capture${kind}Btn" class="btn">ðŸ“¸ Capture</button>
        <button id="retake${kind}Btn" class="btn ghost">Cancel</button>
      </div>`;
    const video = $(`${kind}Video`);
    const captureBtn = $(`capture${kind}Btn`);
    const retakeBtn = $(`retake${kind}Btn`);

    let stream;
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
      video.srcObject = stream;
      video.onloadedmetadata = () => { video.play?.(); };
    } catch (err) {
      setMsg('Camera access denied. Use file picker.', 'error');
      return;
    }

    retakeBtn.onclick = () => {
      try { stream?.getTracks().forEach(t => t.stop()); } catch (_) { }
      container.innerHTML = '';
    };

    captureBtn.onclick = async () => {
      setMsg(spinner(kind === 'front' ? 'Uploading front photoâ€¦' : 'Uploading ingredients photoâ€¦'));
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth; canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);
      try { stream?.getTracks().forEach(t => t.stop()); } catch (_) { }

      const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
      if (kind === 'front') {
        google.script.run
          .withSuccessHandler(() => { setMsg('Front photo saved.', 'success'); promptForIngredients(); })
          .withFailureHandler(err => { console.error(err); setMsg('Upload failed', 'error'); })
          .captureFrontImageFromDataURL(currentUPC, dataUrl);
      } else {
        google.script.run
          .withSuccessHandler(data => { setMsg('Ingredients saved. Review details below.', 'success'); renderConfirmForm(data); })
          .withFailureHandler(err => { console.error(err); setMsg('Upload failed', 'error'); })
          .captureIngredientsFromDataURL(currentUPC, dataUrl);
      }
    };
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Confirm & Save
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function normalizeSpeciesToOption(raw) {
    const s = String(raw || '').toLowerCase();
    if (/puppy|pup|growth|junior|small\s*breed.*puppy/.test(s)) return 'Puppy';
    if (/kitten|kittens|growth/.test(s)) return 'Kitten';
    if (/dog|canine/.test(s)) return 'Dog';
    if (/cat|feline/.test(s)) return 'Cat';
    return '';
  }

  function renderConfirmForm(data) {
    confirmedData = data;
    const speciesGuess = normalizeSpeciesToOption(data.Species);
    const norm = {
      Species: speciesGuess || '',
      Brand: data.Brand || '',
      'Product Name': data['Product Name'] || data.ProductName || '',
      Flavor: data.Flavor || '',
      Ingredients: data.Ingredients || ''
    };
    const isTreatYes = String(data.isTreat || '').toLowerCase() === 'yes';

    resultDiv.innerHTML = `
      <div class="card">
        <h2 style="margin:.25rem 0 1rem 0">Confirm Details</h2>
        <form id="confirmForm" class="row">
          <div class="check-row">
            <input type="checkbox" id="treatsToggle" name="isTreat" ${isTreatYes ? 'checked' : ''}/>
            <label for="treatsToggle">This item is a Treat</label>
          </div>
          <div class="field">
            <label>Species</label>
            <select name="Species" id="speciesSelect">
              <option value="">Selectâ€¦</option>
              <option value="Dog"${(norm.Species==='Dog')?' selected':''}>Dog</option>
              <option value="Puppy"${(norm.Species==='Puppy')?' selected':''}>Puppy</option>
              <option value="Cat"${(norm.Species==='Cat')?' selected':''}>Cat</option>
              <option value="Kitten"${(norm.Species==='Kitten')?' selected':''}>Kitten</option>
            </select>
          </div>
          <label class="field">Brand<input name="Brand" value="${norm.Brand}"></label>
          <label class="field">Product Name<input name="Product Name" value="${norm['Product Name']}"></label>
          <label class="field">Flavor<input name="Flavor" value="${norm.Flavor}"></label>
          <label class="field">Ingredients<textarea name="Ingredients" rows="4">${norm.Ingredients}</textarea></label>
          <button type="submit" class="btn">Save to Database</button>
        </form>
      </div>`;

    // Remove accidental duplicates if any
    const toggles = resultDiv.querySelectorAll('#treatsToggle');
    for (let i = 1; i < toggles.length; i++) {
      const row = toggles[i].closest('.check-row');
      if (row) row.remove();
    }

    const form = $('confirmForm');
    form.onsubmit = (e) => {
      e.preventDefault();
      const formData = Object.fromEntries(new FormData(e.target));
      formData.isTreat = $('treatsToggle').checked ? 'Yes' : 'No';
      confirmedData = { ...confirmedData, ...formData };

      setMsg(spinner('Saving recordâ€¦'));
      google.script.run
        .withSuccessHandler(() => {
          setMsg('Record saved.', 'success');
          expirationContainer.style.display = 'block';
          if (expirationInput.value) createLabelBtn.removeAttribute('disabled'); else createLabelBtn.setAttribute('disabled', '');
          expirationContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        })
        .withFailureHandler(err => {
          console.error(err); setMsg('Save failed', 'error');
        })
        .saveRecord(formData);
    };
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Label creation
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  createLabelBtn.addEventListener('click', () => {
    if (!expirationInput.value) { setMsg('Please select an expiration date.', 'error'); return; }
    createLabelBtn.disabled = true;
    setMsg(spinner('Generating labelâ€¦'));

    const treatsChecked = document.getElementById('treatsToggle')?.checked === true;
    const foodType = treatsChecked ? 'Treats' : 'Food';

    const labelData = { ...confirmedData, Expiration: expirationInput.value, foodType };
    google.script.run
      .withSuccessHandler(res => {
        setMsg('Label ready.', 'success');
        resultDiv.innerHTML = `<div class="card"><a href="${res.url}" target="_blank" rel="noopener">Open 4Ã—6 PDF for printing</a></div>`;
      })
      .withFailureHandler(err => {
        console.error(err); setMsg('Label creation failed', 'error'); createLabelBtn.disabled = false;
      })
      .createLabel(labelData);
  });

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Boot
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  window.addEventListener('load', () => {
    console.clear(); console.log('ðŸ”¥ UI Loaded (split frontend) â€” Scandit-first with Dynamsoft fallback');
  });
})();